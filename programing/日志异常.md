## 日志规范

详细的日志输出级别分为：OFF、FATAL、ERROR、WARN、INFO、DEBUG、ALL和自定义。

比较有用的是ERROR、WARN、INFO和DEBUG。

1. #### ERROR级别

   ERROR表示不能自己恢复的错误，需要立即被关注和解决。例如：数据库操作错误、I/O错误、未知的系统错误等。

   对于ERROR，不仅要打印线程堆栈，最好还打印出一定的上下文信息，以便排查问题。

   ERROR要接入监控和报警系统。要做好ERROR输出的场景定义和规范，再配合监控治理，双管齐下，确保线上系统的稳定。

2. #### WARN级别

   业务问题一般用WARN。短时间产生过多的WARN日志也会影响系统性能。因此，有必要为WARN配置一个适当的阈值，超出则发出报警。

3. #### INFO级别

   INFO用于记录系统的基本运行过程和运行状态。

4. #### DEBUG级别

   DEBUG是输出调试信息，通常在开发和预发环境打开。



## 异常规范

1. #### 异常处理

在业务系统中为了统一处理异常和减少try/catch代码，可以设定两个异常，分别是BizException（业务异常）和SySException（系统异常），而且这两个异常都应该是UncheckedException。

为什么不建议用CheckedException？

因为它破坏了开闭原则。如果在一个方法中抛出了CheckedException，而catch语句在3个层级之上，那么久需要在catch语句和抛出异常之间的每个方法签名中声明该异常。这意味着在软件中修改较低层级时，都将波及较高层级，修改好的模块必须重新构建、发布，畸变他们自身所关注的任何东西都没有被改动过。

针对也无异常和系统异常要做统一的异常处理，类似于AOP，在应用处理请求的切面上处理异常收敛。

```java
try {
    //业务处理
    Response res = process(request);
} catch (BizException e) {
    //业务异常使用WARN级别
    logger.warn("BizException with error code:{}, error message:{}", e.getErrorCode(), e.getErrorMsg());
} catch (SysException e) {
    //系统异常使用ERROR级别
    log.error("System error" + e.getMessage(), e);
} catch (Exception e) {
    //兜底
    log.error("System error" + e.getMessage(), e);
}
```



2. #### 错误码

   错误码非常重要，一定要在系统搭建之初就制定好相应的规范，否则当系统上线后，系统的错误码已经对前端或者外部系统透出，再重构的可能性就很小。

   1. ##### 编号错误码

      对于平台、底层系统或软件产品，可以采用编号式的编码规范。好处是编码风格固定，给人一种正式感。缺点是必须配合文档才能理解错误码表示的意思。

      例如，数据库软件Oracle中总共有2000多个异常，其编码规则是ORA-00001~ORA-02149，每一个错误码都有对应的错误解释。

      - ORA-00001：违反唯一约束条件。
      - ORA-00017：请求会话以设置跟踪事件。
      - ORA-00018：超出最大会话数。
      - ORA-00019：超出最大会话许可数。
      - ORA-00023：会话引用进程私用内存；无法分离会话。
      - ORA-00024：单一进程模式下不允许从多个进程注册。

      淘宝开放平台也采用类似的编码方式，0~100表示平台解析错误，4表示User call limited（ISV调用次数超限）。

      另外要注意，对不同的错误波段，一定要预留足够的码号。例如，淘宝开放平台所用的3位数就显得有些拘谨，其支撑的错误数最多不能超过100，超过100后，为了向后兼容，只能通过子错误码的方式进行变通处理。

   

   1. ##### 显性化错误码

      大型分布式架构下的业务系统中，每个业务都由很多分布式服务组成，而且这些服务都提供给内部系统使用。这种情况下推荐使用显性化的错误码。

      显性化的错误码灵活性强，适合敏捷开发。例如可以把错误码定义成3个部分：类型+场景+自定义标识。

      可以做一个约定：P代表参数异常（ParamException）、B代表业务异常（BizException）、S代表系统异常（SystemException）。

      | 错误类型 | 错误码约定 | 例                                          |
      | -------- | ---------- | ------------------------------------------- |
      | 参数异常 | P_XX_XX    | P_Customer_NameIsNull: 客户姓名不能为空     |
      | 业务异常 | B_XX_XX    | B_Customer_NameAlreadyExist: 客户姓名已存在 |
      | 系统异常 | S_XX_XX    | S_Unknow_Error：未知系统错误                |

      

